<!-- Filename: Cache / Display title: Кэш  -->

## Для Администраторов

В качестве администратора Joomla предоставляет вам возможность кэшировать части вашего сайта. Вы можете выбрать кэширование целых веб-страниц или только их отдельных частей. В этом руководстве объясняется, как это сделать.

На веб-странице сайта Joomla есть 3 элемента, которые могут быть кэшированы:

1. Вся страница целиком – кэш страницы
2. Вывод компонента Joomla для этой веб-страницы – называется кэшем представления
3. Вывод модулей, отображаемых на этой странице – называется кэшем модуля

У вас есть несколько настроек кэша, которые позволяют контролировать, что будет кэшироваться:

1. Системный плагин "System – Page Cache"
2. Глобальная конфигурация, вкладка Система, Настройки кэша. Здесь опцию системного кэша можно установить на
    - ВЫКЛ – кэширование отключено
    - ВКЛ – Консервативное кэширование
    - ВКЛ – Прогрессивное кэширование
3. Во многих модулях в их параметрах есть вкладка "Дополнительно", где можно установить кэширование на *Использовать глобальные* или *Без кэширования*

Как описано ниже, также существуют правила кэширования, которые реализованы в коде Joomla и над которыми у вас нет контроля.

Вы можете очистить кэш через меню Администратор → Система → Очистить кэш. В общем, вы можете рассматривать Joomla как имеющую 3 уровня кэша, увеличивающихся по агрессивности:

1. Консервативное кэширование
2. Прогрессивное кэширование
3. Кэширование страниц

Кроме того, разработчики Joomla могут использовать возможности кэширования для хранения результатов запросов к базе данных, например, чтобы повысить отзывчивость сайта, но это выходит за рамки возможностей администратора.

## Кэширование страниц

Чтобы включить это, перейдите в Администратор → Расширения → Плагины. Затем найдите плагин "Система – Кэш страниц" и включите его. Это означает, что страницы сайта теперь будут кэшироваться, и при повторном запросе будет выдаваться кэшированная страница, а не генерироваться Joomla из информации в базе данных. Кэшированная страница будет выдаваться до истечения срока действия, который определяется параметром *Время кэша* в Администратор → Глобальная конфигурация → вкладка Система → Настройки кэша.

Если вы читаете эту страницу как руководство и хотите протестировать кэширование страниц, лучше установить настройки кэша в Глобальной конфигурации на следующие:

- Обработчик кэша – Файл
- Путь к папке кэша – оставить пустым
- Время кэша – 15 (по умолчанию 15 минут)
- Кэширование для каждой платформы - Нет
- Системный кэш – ВЫКЛ. – Кэширование отключено

Чтобы убедиться, что кэширование страниц работает, перейдите на страницу сайта, где отображается статья. После отображения этой страницы вы должны найти в файловой системе директорию `cache/page` с файлом, который имеет имя типа `xxx-cache-page-yyy.php`, где xxx и yyy - это длинные хэш-строки. Joomla должна хранить отдельные кэш-страницы для отдельных URL, поэтому вторая строка шестнадцатеричных цифр является хэшем URL веб-страницы сайта, чтобы сделать имя файла уникальным для этой страницы.

Затем используйте функциональность Администратора, чтобы изменить текст этой статьи, и снова отобразите веб-страницу сайта. Вы должны обнаружить кэшированную версию, а не ваш измененный текст.

Изменение статьи (или другого элемента Joomla) не очищает кэш страницы для веб-страниц, на которых отображается эта статья. Чтобы очистить кэш страницы, перейдите в Администратор → Система → Очистить кэш. Нажмите на флажок рядом с *Группой кэша* под названием "page" и нажмите кнопку Удалить. Когда вы снова отобразите свою веб-страницу, она должна показать ваш измененный текст.

Если у вашего сайта есть функция, такая как корзина покупок, включение кэширования страниц вызовет проблемы, поскольку страницы должны показывать то, что уже выбрал клиент, а не отображать кэшированную страницу, которая общая для всех. Однако вы можете настроить плагин "Система - Кэш страниц" для исключения кэширования указанных пунктов меню или указанных URL и диапазонов URL (на вкладке "Дополнительно"), чтобы кэшировались только действительно статические страницы.

## Консервативное кэширование

С помощью Консервативного кэширования вы можете кэшировать вывод представления из компонентов и выходные данные из тех модулей, которые разрешают кэширование. Однако обратите внимание, что это будет работать только на страницах, которые не кэшируются с использованием кэша страниц. Для этих страниц кэшируется вся веб-страница, и Консервативное кэширование даже не рассматривается.

Чтобы включить Консервативное кэширование:

1. Перейдите в Администратор → Система → Глобальная конфигурация → вкладка Система и в разделе Настройки кэша установите Системный кэш в положение ВКЛ — Консервативное кэширование.
2. Перейдите в Администратор → Расширения → Модули и выберите модули, которые вы хотите закэшировать. Если этот модуль разрешает кэширование, то на вкладке Расширенные вы должны иметь возможность установить параметр Кэширование в:

- Использовать глобальные настройки — этот модуль будет кэшироваться (с учетом того, что глобальный параметр теперь установлен на Консервативное кэширование).
- Без кэширования — этот модуль не будет кэшироваться.

(Обратите внимание, что время кэширования в Глобальной конфигурации указывается в минутах, а время кэширования в настройках модуля — в секундах.)

Чтобы проверить, работает ли это, перейдите на ваш сайт, **убедитесь, что вы вышли из системы**, и перейдите на веб-страницу, которая отображает статью. Проверьте вашу файловую систему, и вы должны найти папку `cache/com_content` содержащую файл кэша.

Вы также найдете другие директории, такие как `cache/com_languages` (поскольку отображение страницы включает загрузку текущего языка, который также будет кэшироваться), а также директории, относящиеся к кэшу модуля, например, `cache/com_modules`. Эти результаты получены в результате использования кэша, который разработчики закодировали в приложении Joomla.

Если вы отредактируете и сохраните эту статью, а затем обновите страницу сайта, вы увидите, что сайт теперь отображает обновленный текст. Это происходит потому, что всякий раз, когда редактирование сохраняется, Joomla очищает кэш для этой статьи.

Тем не менее, вы можете продемонстрировать работу кэша, если отредактируете файл кэша в директории `cache/com_content` с помощью простого текстового редактора. С помощью редактора измените одну букву в тексте статьи в файле кэша и сохраните файл. Затем, когда вы обновите веб-страницу, вы должны увидеть изменение, которое вы внесли в файл кэша.

Как вы можете выбрать, какие представления компонентов кэшируются и при каких обстоятельствах? Увы, вы не можете это сделать. Это определяется разработчиками основных компонентов Joomla и закодировано в коде PHP компонента. Критерии различны для каждого компонента. Однако вы можете легко узнать, какие критерии используются, потому что для каждого из компонентов сайта они закодированы в файле `DisplayController.php` компонента сайта. Например, на момент этой редакции (версии Joomla 5) для компонента Контакты мы находим в `components/com_contact/src/Controller/DisplayController.php`

```php
    public function display($cachable = false, $urlparams = [])
    {
        if ($this->app->getUserState('com_contact.contact.data') === null) {
            $cachable = true;
        }
```

Это означает, что представления, связанные с контактами, будут кэшируемыми, если нет данных сессии с ключом `com_contact.contact.data` – это произойдет, если в сеансе пользователя пользователь отобразил контактную форму (например, на странице, на которую указывает пункт меню типа Контакты → Один контакт).

Эквивалентный файл для статей `components/com_content/src/Controller/DisplayController.php` содержит:

```php
    public function display($cachable = false, $urlparams = false)
    {
        $cachable = true;

        /**
         * Установите имя и формат представления по умолчанию из запроса.
         * Обратите внимание, что мы используем a_id во избежание конфликтов с маршрутизатором и возвратом страницы.
         * Интерфейс немного более запутанный, чем обратная сторона.
         */
        $id    = $this->input->getInt('a_id');
        $vName = $this->input->getCmd('view', 'categories');
        $this->input->set('view', $vName);

        $user = $this->app->getIdentity();

        if (
            $user->get('id')
            || ($this->input->getMethod() === 'POST'
            && (($vName === 'category' && $this->input->get('layout') !== 'blog') || $vName === 'archive'))
        ) {
            $cachable = false;
        }
```

Выражение `$user->get('id')` истинно, если это пользователь, вошедший в систему. Это означает, что статьи никогда не кэшируются для пользователей, вошедших в систему. Последующие выражения относятся к другим условиям, когда кэширование не выполняется, даже если пользователь не вошел в систему.

Таким образом, вы можете узнать обстоятельства, при которых выполняется кэширование, но изменять их не рекомендуется. Вы также можете продемонстрировать, что модули кэшируются, используя модуль Навигационных цепочек Joomla, убедившись, что он отображается в некоторой позиции модуля на веб-странице, установив его опцию Кэширования и вручную отредактировав закэшированный файл в `cache/mod_breadcrumbs`.

## Прогрессивное кэширование

Как и в случае консервативного кэширования, прогрессивное кэширование также сохраняет выходные данные из представлений компонентов и модулей. Функциональное отличие между ними заключается в том, что при прогрессивном кэшировании **для незарегистрированных пользователей все модули всегда кэшируются**. В этом случае установка опции *Без кэширования* для модуля не имеет эффекта. Если в качестве опции хранения кэша установлено значение *Файл*, вы можете найти файл кэша модулей (выходные данные всех модулей хранятся в одном файле) в каталоге `cache/com_modules`.

Чтобы включить прогрессивное кэширование, перейдите в Администратор → Система → Глобальная конфигурация → вкладка Система и в разделе *Настройки кэша* установите *Кэширование системы* на *ВКЛЮЧЕНО – Прогрессивное кэширование*.

Что касается условий кэширования представлений основных компонентов Joomla, **нет никакой разницы между консервативным и прогрессивным кэшированием**. Несмотря на то, что вы можете прочитать на некоторых сайтах и в ответах на вопросы Stack Overflow, неправильно считать, что консервативное кэширование относится к случаю, когда пользователь не вошел в систему, а прогрессивное кэширование — к случаю, когда пользователь вошел в систему.

## Резюме

Ниже приведено резюме типов кеширования.

### Кеширование всей страницы

- **Настройка**: Встроенный плагин (Администратор → Расширения → Менеджер плагинов → Система - Кеш страницы)
- **Кеширует**: каждую целую страницу вашего сайта
- **Основано на**: URL
- **Дополнительная информация**:
  - Опциональное кеширование в браузере: также кеширует в браузере/компьютере ваших посетителей
  - Кеширует только страницы для гостей (не для вошедших пользователей). Будьте осторожны при использовании этого плагина, если у вас интерактивный сайт, где вы хотите предоставлять контент, основываясь на информации сессии/куки, а не только на простом URL. Такие функции, как корзина покупок, не будут работать.

### Кеширование представлений

- **Настройка**: Глобальная конфигурация → Кеш
- **Кеширует**: каждое представление компонента
- **Основано на**: URL, представление, параметры и т.д.
- **Дополнительная информация**: Разработчики компонентов должны включать это в свой код для работы. Чаще всего этого не делают. Основной компонент контента Joomla использует это, но только для гостей вашего сайта, хотя это не является обязательным для каждого компонента.

### Кеширование модулей

- **Настройка**: Глобальная конфигурация → Кеш
- **Кеширует**: каждый модуль (индивидуально настраивается через расширенные параметры каждого модуля)
- **Основано на**: id модуля, уровнях просмотра пользователя и параметре *Itemid* в HTTP запросе
- **Дополнительная информация**: Вы должны отключить кеширование на некоторых модулях, чтобы избежать проблем

### Дополнительное кеширование

Если вы хотите изучить другие системы кеширования и возможности, вам может быть интересно рассмотреть сторонние расширения для кеширования.

### Движки или хранилища кеширования

- **Настройка**: Глобальная конфигурация → Кеш

Здесь вы можете выбрать, какую систему вы хотите использовать для кеширования на вашем сайте. Некоторые варианты включают: APC, Eaccelorator, File, Memcache, Redis, XCache.

Например, APC также кеширует ваш PHP opcode.

## Для разработчиков

<div class="alert alert-warning">
Этот раздел требует пересмотра для Joomla! 4/5.
</div>

Класс **JCache** позволяет использовать множество различных видов и уровней кеширования. Следующие подклассы созданы специально, но вы можете добавлять свои собственные или использовать основной класс различными способами.

Не забывайте, что первый уровень кеширования, с которым вы сталкиваетесь, перезаписывает любое более глубокое кеширование. Полагаю, что слишком много уровней также неэффективно (*хотя это надо проверить*).

- **JCacheView** кеширует и возвращает вывод заданного представления (в MVC). Идентификатор кеша автоматически генерируется из URI, конкретного представления и его конкретного метода, или вы можете задать свой собственный.

Это можно сделать автоматически через функцию вывода базового контроллера. Например, в контроллере вашего компонента:

    class DeliciousController extends JController {
        function display() {
            parent::display(true); //true запрашивает кеширование.
        }
    }

Также есть некоторые urlparams, которые стоит учитывать. Ознакомьтесь с этой
[темой на Joomla StackExchange](http://joomla.stackexchange.com/questions/5781/how-can-i-use-joomlas-cache-with-my-components-view/7000#7000)

Также имейте в виду, что любые обновления (например, количество посещений или просмотров) НЕ будут обновляться (если только вы не добавите это за пределами этого метода и, следовательно, любой глубокой части MVC).

- **JCachePage** кеширует и возвращает тело страницы.
- **JCacheCallback** кеширует и возвращает вывод и результаты функций или методов.

Если вы хотите кешировать запросы, это хороший класс для этого, как показано здесь: Использование кеширования для ускорения вашего кода.

- **JCacheOutput** кеширует и возвращает вывод.

Это скорее предназначено для кеширования конкретной части PHP-кода. Он действует как буфер вывода, но кешированный.

